import{a as Ue,b as Ce}from"./chunk-X2XAQUUD.js";import{a as ke,b as Ne,c as Me,d as Re,e as R,f as Ae,h as Oe,i as xe,j as T,k as _e,l as $e,m as Be,n as A,o as O}from"./chunk-EM6BKBN7.js";import{$b as we,A as ie,Ca as fe,E as oe,Ea as f,F as q,Fa as c,Ga as y,Hb as S,J as u,L as h,La as z,Lb as ge,M as p,N as a,Ob as Se,P as se,Pa as ue,Pb as b,Qb as ve,Rb as Ee,Tb as ye,Vb as Ie,Wb as be,Xa as g,Y as ne,Z as ae,Zb as Te,_b as Fe,a as F,ab as le,cb as M,f as P,g as Z,h as w,i as j,l as U,la as ce,m as C,ma as m,n as I,na as E,o as L,p as V,pb as de,q as G,r as k,rb as pe,s as N,t as H,tc as je,u as Q,v as ee,vb as me,w as te,wa as Y,y as re,ya as l,yb as he,z as J}from"./chunk-7VGRZGUI.js";var De=(()=>{let r=class r{constructor(){this._isUsedByNgShop$=new j(!1),this.isUsedByNgShop$=this._isUsedByNgShop$.asObservable()}setIsUsedByNgShop(){this._isUsedByNgShop$.next(!0)}};r.\u0275fac=function(i){return new(i||r)},r.\u0275prov=u({token:r,factory:r.\u0275fac,providedIn:"root"});let e=r;return e})();var v=(()=>{let r=class r{constructor(t,i){this.http=t,this.usersFacade=i,this._loggedInUser$=new j(this.getToken()),this.loggedInUser$=this._loggedInUser$.asObservable()}login({email:t,password:i}){return this.http.post("http://localhost:3000/api/v1/users/login",{email:t,password:i})}logout(){localStorage.removeItem("jwtToken"),this._loggedInUser$.next(null)}logoutNgShop(){this.usersFacade.userSessionLogout()}loginNgShop(t){this.usersFacade.userSessionLogin(t)}saveTokenAdminPanel(t){return JSON.parse(atob(t.split(".")[1])).isAdmin?(localStorage.setItem("jwtToken",t),this._loggedInUser$.next(t),!0):!1}saveTokenNgShop(t){let i=atob(t.split(".")[1]),o=JSON.parse(i);this.isTokenExpried(o.exp)||localStorage.setItem("jwtToken",t)}getToken(){return localStorage.getItem("jwtToken")}getUserIdFromToken(){let t=this.getToken();if(t){let i=JSON.parse(atob(t.split(".")[1]));return i?i.userId:null}return null}isValidToken(){let t=this.getToken();if(t){let i=JSON.parse(atob(t.split(".")[1]));return!this.isTokenExpried(i)}else return!1}isTokenExpried(t){return Math.floor(new Date().getTime()/1e3)>=t}get loggedInUser(){return this._loggedInUser$.value}};r.\u0275fac=function(i){return new(i||r)(p(he),p(A))},r.\u0275prov=u({token:r,factory:r.\u0275fac,providedIn:"root"});let e=r;return e})();var Xe={dispatch:!0,functional:!1,useEffectsErrorHandler:!0},_="__@ngrx/effects_create__";function $(e,r={}){let s=r.functional?e:e(),t=F(F({},Xe),r);return Object.defineProperty(s,_,{value:t}),s}function Ze(e){return Object.getOwnPropertyNames(e).filter(t=>e[t]&&e[t].hasOwnProperty(_)?e[t][_].hasOwnProperty("dispatch"):!1).map(t=>{let i=e[t][_];return F({propertyName:t},i)})}function Qe(e){return Ze(e)}function Pe(e){return Object.getPrototypeOf(e)}function et(e){return!!e.constructor&&e.constructor.name!=="Object"&&e.constructor.name!=="Function"}function Le(e){return typeof e=="function"}function tt(e){return e.filter(Le)}function rt(e,r,s){let t=Pe(e),o=!!t&&t.constructor.name!=="Object"?t.constructor.name:null,n=Qe(e).map(({propertyName:d,dispatch:D,useEffectsErrorHandler:Ke})=>{let W=typeof e[d]=="function"?e[d]():e[d],X=Ke?s(W,r):W;return D===!1?X.pipe(ee()):X.pipe(ie()).pipe(I(We=>({effect:e[d],notification:We,propertyName:d,sourceName:o,sourceInstance:e})))});return G(...n)}var it=10;function Ve(e,r,s=it){return e.pipe(N(t=>(r&&r.handleError(t),s<=1?e:Ve(e,r,s-1))))}var Ge=(()=>{let r=class r extends Z{constructor(t){super(),t&&(this.source=t)}lift(t){let i=new r;return i.source=this,i.operator=t,i}};r.\u0275fac=function(i){return new(i||r)(p(Re))},r.\u0275prov=u({token:r,factory:r.\u0275fac,providedIn:"root"});let e=r;return e})();function B(...e){return k(r=>e.some(s=>typeof s=="string"?s===r.type:s.type===r.type))}var zt=new h("@ngrx/effects Internal Root Guard"),Kt=new h("@ngrx/effects User Provided Effects"),Wt=new h("@ngrx/effects Internal Root Effects"),Xt=new h("@ngrx/effects Internal Root Effects Instances"),Zt=new h("@ngrx/effects Internal Feature Effects"),Qt=new h("@ngrx/effects Internal Feature Effects Instance Groups"),ot=new h("@ngrx/effects Effects Error Handler",{providedIn:"root",factory:()=>Ve}),st="@ngrx/effects/init",nt=ke(st);function at(e,r){if(e.notification.kind==="N"){let s=e.notification.value;!ct(s)&&r.handleError(new Error(`Effect ${ft(e)} dispatched an invalid action: ${ut(s)}`))}}function ct(e){return typeof e!="function"&&e&&e.type&&typeof e.type=="string"}function ft({propertyName:e,sourceInstance:r,sourceName:s}){let t=typeof r[e]=="function";return!!s?`"${s}.${String(e)}${t?"()":""}"`:`"${String(e)}()"`}function ut(e){try{return JSON.stringify(e)}catch{return e}}var lt="ngrxOnIdentifyEffects";function dt(e){return K(e,lt)}var pt="ngrxOnRunEffects";function mt(e){return K(e,pt)}var ht="ngrxOnInitEffects";function gt(e){return K(e,ht)}function K(e,r){return e&&r in e&&typeof e[r]=="function"}var He=(()=>{let r=class r extends w{constructor(t,i){super(),this.errorHandler=t,this.effectsErrorHandler=i}addEffects(t){this.next(t)}toActions(){return this.pipe(J(t=>et(t)?Pe(t):t),L(t=>t.pipe(J(St))),L(t=>{let i=t.pipe(re(n=>vt(this.errorHandler,this.effectsErrorHandler)(n)),I(n=>(at(n,this.errorHandler),n.notification)),k(n=>n.kind==="N"&&n.value!=null),te()),o=t.pipe(Q(1),k(gt),I(n=>n.ngrxOnInitEffects()));return G(i,o)}))}};r.\u0275fac=function(i){return new(i||r)(p(ce),p(ot))},r.\u0275prov=u({token:r,factory:r.\u0275fac,providedIn:"root"});let e=r;return e})();function St(e){return dt(e)?e.ngrxOnIdentifyEffects():""}function vt(e,r){return s=>{let t=rt(s,e,r);return mt(s)?s.ngrxOnRunEffects(t):t}}var Et=(()=>{let r=class r{get isStarted(){return!!this.effectsSubscription}constructor(t,i){this.effectSources=t,this.store=i,this.effectsSubscription=null}start(){this.effectsSubscription||(this.effectsSubscription=this.effectSources.toActions().subscribe(this.store))}ngOnDestroy(){this.effectsSubscription&&(this.effectsSubscription.unsubscribe(),this.effectsSubscription=null)}};r.\u0275fac=function(i){return new(i||r)(p(He),p(R))},r.\u0275prov=u({token:r,factory:r.\u0275fac,providedIn:"root"});let e=r;return e})();function Je(...e){let r=e.flat(),s=tt(r);return ae([s,{provide:ne,multi:!0,useValue:()=>{a(Ne),a(Me,{optional:!0});let t=a(Et),i=a(He),o=!t.isStarted;o&&t.start();for(let n of r){let d=Le(n)?a(n):n;i.addEffects(d)}o&&a(R).dispatch(nt())}}])}var qe=(()=>{let r=class r{constructor(){this.actions$=a(Ge),this.authService=a(v),this.usersService=a(O),this.buildUserSession$=$(()=>this.actions$.pipe(B(Oe),H(()=>{if(this.authService.isValidToken()){let t=this.authService.getUserIdFromToken();return t?this.usersService.getUserById(t).pipe(I(i=>xe({user:i})),N(()=>U(T()))):U(T())}else return U(T())}))),this.buildUserSessionFailed$=$(()=>this.actions$.pipe(B(T),q(()=>{localStorage.removeItem("jwtToken")})),{dispatch:!1}),this.userSessionLogout$=$(()=>this.actions$.pipe(B(_e),q(()=>{localStorage.removeItem("jwtToken")})),{dispatch:!1})}};r.\u0275fac=function(i){return new(i||r)},r.\u0275prov=u({token:r,factory:r.\u0275fac});let e=r;return e})();function yt(e,r){e&1&&(f(0,"small"),g(1,"Email is required!"),c())}function It(e,r){e&1&&(f(0,"small"),g(1,"Email is not valid!"),c())}function bt(e,r){e&1&&(f(0,"small"),g(1,"Password is required!"),c())}function Tt(e,r){e&1&&(f(0,"small"),g(1,"Minimum 6 characters!"),c())}var Ft=e=>({removeHeight:e}),Ye=e=>({submitted:e}),ze=(()=>{let r=class r{constructor(t,i,o,n,d,D){this.formBuilder=t,this.authService=i,this.messageService=o,this.router=n,this.utilsService=d,this.usersService=D,this.form=this.formBuilder.group({email:["",[b.required,b.email]],password:["",[b.required,b.minLength(6)]]}),this.isSubmitted=!1,this.isPasswordShown=!1,this.isUsedByNgShop=!1,this.endSubs$=new w}ngOnInit(){this._checkFromNgShop()}onSubmitLogin(){this.isSubmitted=!0,!this.form.invalid&&(this.isUsedByNgShop?this._loginNgShop():this._loginAdminPanel())}_loginAdminPanel(){this.authService.login(this.form.value).subscribe({next:t=>P(this,null,function*(){this.authService.saveTokenAdminPanel(t.token)?(this.messageService.add({severity:"success",summary:"Success",detail:"You are logged in successfully!"}),yield C(V(2e3)),this.router.navigateByUrl("/")):this.messageService.add({severity:"error",summary:"Error",detail:"You are not an admin!"})}),error:t=>{this.messageService.add({severity:"error",summary:"Error",detail:t.status!==400?"Server error, please try again later!":"Email or password incorrect"})}})}_loginNgShop(){this.authService.login(this.form.value).subscribe({next:t=>P(this,null,function*(){if(t&&t.token){this.authService.saveTokenNgShop(t.token);let i=this.authService.getUserIdFromToken();if(i){let o=this.usersService.getUserById(i),n=yield C(o);this.authService.loginNgShop(n),this.messageService.add({severity:"success",summary:"Success",detail:"You are logged in successfully!"}),yield C(V(2e3)),this.router.navigateByUrl("/")}}}),error:t=>{this.messageService.add({severity:"error",summary:"Error",detail:t.status!==400?"Server error, please try again later!":"Email or password incorrect"})}})}_checkFromNgShop(){this.utilsService.isUsedByNgShop$.pipe(oe(this.endSubs$)).subscribe({next:t=>{t&&(this.isUsedByNgShop=t)},error:t=>{console.error("Cannot get UsedByNgShop",t)}})}get formControls(){return this.form.controls}ngOnDestroy(){this.endSubs$.next(null),this.endSubs$.complete()}};r.\u0275fac=function(i){return new(i||r)(E(Te),E(v),E(je),E(S),E(De),E(O))},r.\u0275cmp=se({type:r,selectors:[["users-login"]],standalone:!0,features:[le],decls:30,vars:18,consts:[[1,"login-page",3,"ngClass"],[1,"login-container"],[1,"img"],["src","http://localhost:3000/public/uploads/login-register/login-register.jpg","alt","login"],[1,"red-cover"],[1,"login-inner-container"],[1,"header"],[1,"form-login",3,"formGroup","ngSubmit"],[1,"email-input"],[1,"email"],["for","email"],[1,"pi","pi-user"],["formControlName","email","type","email","name","email","id","email","placeholder","Email",3,"ngClass"],[4,"ngIf"],[1,"password-input"],[1,"password"],["for","password"],[1,"pi","pi-ellipsis-h"],["formControlName","password","name","password","id","password","placeholder","Password",3,"type","ngClass"],[1,"eye","pi",3,"title","click"],["type","submit",1,"btn-login"]],template:function(i,o){i&1&&(f(0,"section",0)(1,"div",1)(2,"div",2),y(3,"img",3)(4,"div",4),c(),f(5,"div",5)(6,"div",6)(7,"h1"),g(8,"eShop"),c(),f(9,"h2"),g(10,"Admin Panel"),c()(),f(11,"form",7),z("ngSubmit",function(){return o.onSubmitLogin()}),f(12,"div",8)(13,"div",9)(14,"label",10),y(15,"i",11),c(),y(16,"input",12),c(),Y(17,yt,2,0,"small",13)(18,It,2,0,"small",13),c(),f(19,"div",14)(20,"div",15)(21,"label",16),y(22,"i",17),c(),y(23,"input",18),f(24,"i",19),z("click",function(){return o.isPasswordShown=!o.isPasswordShown}),c()(),Y(25,bt,2,0,"small",13)(26,Tt,2,0,"small",13),c(),f(27,"button",20),g(28,"Login"),c()()()()(),y(29,"p-toast")),i&2&&(l("ngClass",M(12,Ft,o.isUsedByNgShop)),m(11),l("formGroup",o.form),m(5),l("ngClass",M(14,Ye,o.isSubmitted)),m(),l("ngIf",o.formControls.email.hasError("required")&&o.isSubmitted),m(),l("ngIf",o.formControls.email.hasError("email")&&o.isSubmitted),m(5),ue("type",o.isPasswordShown?"text":"password"),l("ngClass",M(16,Ye,o.isSubmitted)),m(),fe(o.isPasswordShown?"pi-eye-slash":"pi-eye"),l("title",o.isPasswordShown?"Hide":"Show"),m(),l("ngIf",o.formControls.password.hasError("required")&&o.isSubmitted),m(),l("ngIf",o.formControls.password.hasError("minlength")&&o.isSubmitted))},dependencies:[me,de,pe,ge,Fe,ye,Se,ve,Ee,we,Ie,be,Ce,Ue]});let e=r;return e})();var Nr=[{path:"",component:ze,providers:[A,Ae($e,Be),Je([qe])]}];function xr(){let e=a(v),r=e.getToken();if(!r)return a(S).navigateByUrl("login"),!1;try{let s=atob(r.split(".")[1]),t=JSON.parse(s);return t.isAdmin&&!e.isTokenExpried(t.exp)?!0:(a(S).navigateByUrl("login"),!1)}catch{return console.error("Error decoding JWT token"),a(S).navigateByUrl("login"),!1}}function Pr(){return a(v).getToken()?(console.error("User is already logged in"),a(S).navigateByUrl("/"),!1):!0}export{De as a,v as b,Je as c,qe as d,ze as e,Nr as f,xr as g,Pr as h};
